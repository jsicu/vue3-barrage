(function(o,s){typeof exports=="object"&&typeof module!="undefined"?module.exports=s(require("vue")):typeof define=="function"&&define.amd?define(["vue"],s):(o=typeof globalThis!="undefined"?globalThis:o||self,o.Vue3Barrage=s(o.Vue))})(this,function(o){"use strict";var ee=Object.defineProperty,te=Object.defineProperties;var oe=Object.getOwnPropertyDescriptors;var N=Object.getOwnPropertySymbols;var ne=Object.prototype.hasOwnProperty,le=Object.prototype.propertyIsEnumerable;var T=(o,s,r)=>s in o?ee(o,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):o[s]=r,y=(o,s)=>{for(var r in s||(s={}))ne.call(s,r)&&T(o,r,s[r]);if(N)for(var r of N(s))le.call(s,r)&&T(o,r,s[r]);return o},C=(o,s)=>te(o,oe(s));var s="";const r={key:1,class:"normal"},E={class:"barrage-msg"},Q=o.defineComponent({name:"barrage",props:{item:{type:Object,default:{}},isSlot:{type:Boolean,default:!1}},setup(u){return(c,f)=>(o.openBlock(),o.createElementBlock("div",{class:o.normalizeClass([u.item.position==="normal"?"barrage-normal":"barrage-fixed"]),style:o.normalizeStyle(u.item.style)},[u.isSlot?o.renderSlot(c.$slots,"default",{key:0}):(o.openBlock(),o.createElementBlock("div",r,[o.createElementVNode("div",E,o.toDisplayString(u.item.msg||"\u5F39\u5E55\u6CA1\u5185\u5BB9\u5440"),1)]))],6))}});var ae="",A=(u,c)=>{const f=u.__vccOpts||u;for(const[i,p]of c)f[i]=p;return f};const R={name:"vue3Barrage"},q=o.defineComponent(C(y({},R),{props:{type:null,attachId:null,isShow:{type:Boolean,default:!0},list:null,lanesCount:{default:5},boxWidth:{default:0},boxHeight:{default:0},fontSize:{default:18},loop:{type:Boolean,default:!1},defineLanes:null,speed:{default:6}},emits:["barrage-list-empty","maxRows"],setup(u,{expose:c,emit:f}){const i=u,{slots:p}=o.getCurrentInstance();window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,window.cancelAnimationFrame=window.cancelAnimationFrame||window.mozCancelAnimationFrame||function(t){clearTimeout(t)};const e=o.reactive({isSlot:!!(p!=null&&p.barrage),boxWidthVal:i.boxWidth,boxHeightVal:0,loopVal:i.loop,speedVal:i.speed,laneNum:0,startTime:0,frameId:null,readyId:null,normalQueue:[],topQueue:[],bottomFixQueue:[],topFixQueue:[],fixQueue:{top:[],bottom:[]},showInd:0,indexShowQueue:null,taskQueue:[],taskIsRunning:!1,taskLastTime:0,lineHeight:14,fixLineNum:0}),m=3e3,D=1.8,M=20,w=o.ref();o.onMounted(()=>{if(i.attachId){const t=document.getElementById(i.attachId),n=document.getElementById("vueBarrageDom");t&&t.appendChild(n)}S(),g(),H(),e.boxWidthVal===0&&(e.boxWidthVal=w.value.parentNode.offsetWidth),e.speedVal>=1&&e.speedVal<=10||(e.speedVal=6),P(),b()}),o.watch(i.list,(t,n)=>{j()}),o.watch(()=>i.boxHeight,(t,n)=>{g()}),o.watch(()=>i.lanesCount,(t,n)=>{g()}),o.watch(()=>i.speed,(t,n)=>{t>=1&&t<=10?e.speedVal=t:e.speedVal=6}),o.watch(()=>i.fontSize,(t,n)=>{H(),g();for(let l=0;l<e.topQueue.length;l++){const a=e.topQueue[l].laneQueue;for(const d of a)x(d,l)}}),o.watch(()=>e.fixLineNum,(t,n)=>{e.bottomFixQueue.forEach((l,a)=>{x(l,a)}),e.topFixQueue.forEach((l,a)=>{x(l,a)}),n>t&&(e.bottomFixQueue.splice(e.fixLineNum),e.topFixQueue.splice(e.fixLineNum))});const $=()=>{if(i.boxHeight)e.boxHeightVal=i.boxHeight;else{const t=w.value.parentNode.offsetHeight;e.boxHeightVal=t===0?window.innerHeight:t}},g=()=>{const t=e.topQueue.length;$(),S();const n=Math.floor(e.boxHeightVal/e.lineHeight);if(i.lanesCount>0&&i.lanesCount<=n?e.laneNum=i.lanesCount:e.laneNum=n,t<=e.laneNum)for(let l=t;l<e.laneNum;l++)e.topQueue.push({id:l,laneQueue:[]});else e.topQueue.splice(e.laneNum)},P=()=>{let t=e.laneNum;e.indexShowQueue=Array.from({length:t},(n,l)=>l)},j=()=>{clearTimeout(e.readyId),e.readyId=setTimeout(()=>{for(;i.list.length>0;){let t=i.list.splice(0,e.laneNum);O(()=>{e.normalQueue=[...e.normalQueue,...t]})}V()},300)},O=t=>{e.taskQueue.push(t),e.taskQueue.length>0&&!e.taskIsRunning&&(e.taskIsRunning=!0,window.requestAnimationFrame(_))},V=t=>{e.startTime==null&&(e.startTime=t),typeof t!="undefined"&&J(t),e.normalQueue.length>0||e.bottomFixQueue.length>0||e.topFixQueue.length>0?b():(f("barrage-list-empty"),e.frameId=null)},b=()=>{e.frameId=requestAnimationFrame(V)},G=()=>{cancelAnimationFrame(e.frameId)},U=()=>{b()},J=t=>{e.normalQueue.forEach((n,l)=>{if(n.startTime){if(n.position==="normal"&&(K(n,t),n.left+n.width<0)){if(!e.topQueue[n.laneId])return;const a=e.topQueue[n.laneId].laneQueue.findIndex(d=>d.runtimeId===n.runtimeId);e.topQueue[n.laneId].laneQueue.splice(a,1),e.loopVal?I(n,t):e.normalQueue.splice(l,1)}}else{if(n.position==="top"||n.position==="bottom"){if(n.position!=="top"&&n.position!=="bottom")throw new Error("Position only between top and bottom when the type equal 1");X(n),e.normalQueue.splice(l,1)}I(n,t)}}),Y(t)},K=(t,n)=>{let l=n-t.currentTime;t.currentTime=n;let a=e.boxWidthVal/(e.speedVal*m)*l;const d=L(t.msg)/m;a<=0||isNaN(a)||(t.left-=a+d,k(t))},X=t=>{e.fixLineNum>e[t.position+"FixQueue"].length?(x(t,e[t.position+"FixQueue"].length),e[t.position+"FixQueue"].push(t)):e.fixQueue[t.position].includes(t)||e.fixQueue[t.position].push(t)},Y=t=>{e.bottomFixQueue.forEach((n,l)=>{n.startTime+e.speedVal*m/3<=t&&F("bottom",t,l)}),e.topFixQueue.forEach((n,l)=>{n.startTime+e.speedVal*m/3<=t&&F("top",t,l)})},F=(t,n,l)=>{if(e.fixQueue[t].length>0){const a=e.fixQueue[t][0];a.startTime=n,x(a,l),e[`${t}FixQueue`][l]=a,e.fixQueue[t].splice(0,1)}else e[`${t}FixQueue`].splice(l,1)},Z=()=>{if(console.log(i.defineLanes),i.defineLanes){const t=i.defineLanes(e.topQueue)-1;if(t<e.topQueue.length&&t>=0)return t;throw new Error("lane index should be >0 and <= lanesCount")}else return e.showInd+1>e.laneNum&&(e.showInd=0),e.showInd++},I=(t,n)=>{if(t.runtimeId=v(),t.startTime=n,t.currentTime=n,t.position==="normal"){const l=L(t.msg);t.width=l*i.fontSize*1.2;let a=Z();t.laneId=a;let d=e.boxWidthVal;if(e.topQueue[a]&&e.topQueue[a].laneQueue.length>0){const h=e.topQueue[a].laneQueue[e.topQueue[a].laneQueue.length-1];h.left>e.boxWidthVal||h.left>e.boxWidthVal-h.width?d=h.width+h.left:d+=h.width}e.topQueue[a].laneQueue.push(t),t.top=e.indexShowQueue[a]*e.lineHeight,t.left=d,k(t)}},x=(t,n)=>{t.position==="bottom"?t.top=e.boxHeightVal-e.lineHeight*(n+1):t.top=e.lineHeight*n,k(t)},k=t=>{t.style={transform:"translate3d("+(t.left||0)+"px,"+t.top+"px,0)","font-size":i.fontSize+"px"}},_=t=>{if(!e.taskLastTime||t-e.taskLastTime>=M){let n=e.taskQueue.shift();e.taskLastTime=t,n()}e.taskQueue.length>0?window.requestAnimationFrame(_):e.taskIsRunning=!1},S=()=>{f("maxRows",Math.trunc(e.boxHeightVal/e.lineHeight))},H=()=>{e.lineHeight=Math.ceil(i.fontSize*D),e.fixLineNum=Math.trunc(e.boxHeightVal/e.lineHeight/2)},L=t=>{let n=0;for(let l in t)t.charCodeAt(l)>127||t.charCodeAt(l)===94?n+=2:n++;return n},v=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=Math.random()*16|0,l=t=="x"?n:n&3|8;return l.toString(16)});return c({pause:G,replay:U}),(t,n)=>o.withDirectives((o.openBlock(),o.createElementBlock("div",{class:"barrage-stage",style:o.normalizeStyle({width:e.boxWidthVal+"px",height:e.boxHeightVal+"px"}),id:"vueBarrageDom",ref_key:"barrageDom",ref:w},[(o.openBlock(!0),o.createElementBlock(o.Fragment,null,o.renderList(e.topQueue,l=>(o.openBlock(),o.createElementBlock("div",{class:"barrage-top",key:l.id},[(o.openBlock(!0),o.createElementBlock(o.Fragment,null,o.renderList(l.laneQueue,a=>(o.openBlock(),o.createBlock(Q,{key:a.runtimeId,item:a,isSlot:e.isSlot},{default:o.withCtx(()=>[o.renderSlot(t.$slots,"barrage",{item:a},void 0,!0)]),_:2},1032,["item","isSlot"]))),128))]))),128)),(o.openBlock(!0),o.createElementBlock(o.Fragment,null,o.renderList(e.topFixQueue,(l,a)=>(o.openBlock(),o.createBlock(Q,{key:a,item:l,isSlot:e.isSlot},{default:o.withCtx(()=>[o.renderSlot(t.$slots,"barrage",{item:l},void 0,!0)]),_:2},1032,["item","isSlot"]))),128)),(o.openBlock(!0),o.createElementBlock(o.Fragment,null,o.renderList(e.bottomFixQueue,(l,a)=>(o.openBlock(),o.createBlock(Q,{key:a,item:l,isSlot:e.isSlot},{default:o.withCtx(()=>[o.renderSlot(t.$slots,"barrage",{item:l},void 0,!0)]),_:2},1032,["item","isSlot"]))),128))],4)),[[o.vShow,u.isShow]])}}));var z=A(q,[["__scopeId","data-v-25c4cd6d"]]);const B=[z];var W=y({install:u=>{B.map(c=>{u.component(c.name,c)})}},B);return W});
